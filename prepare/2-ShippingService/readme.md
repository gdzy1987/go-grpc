##
- 客户端插入+请求货物信息，服务端返回状态和货物信息
- 示例来源
```
 article: https://wuyin.io/2018/05/10/microservices-part-1-introduction-and-consignment-service/
 github: https://github.com/wuYin/shippy/tree/master/consignment-cli
         https://github.com/wuYin/shippy/tree/master/consignment-service
```
### 目录结构
```
.
├── Golang微服务教程1|wuYinIO.pdf
├── Makefile
├── client.go                               // 调用微服务的客户端
├── consignment.json                        // 示例所使用的插入consignment数据文件
├── proto
│   ├── consignment.pb.go                   // protoc 为 gRPC 生成的读写数据的函数
│   └── consignment.proto                   // 定义客户端请求、服务端响应的数据格式
├── readme.md
└── server.go                               // 实现微服务的服务端
```
### 示例运行步骤
```
1. go run server.go
2. go run client.go
```

### 步骤
- 创建proto文件夹
- 在proto文件夹下创建consignment.proto,定义ShippingService微服务
```
syntax = "proto3";
package go.micro.srv.consignment;

//service 定义开放调用的服务，即ShippingService微服务
//货轮微服务
service ShippingService{
    //托运一批货物
    rpc CreateConsignment(Consignment) returns (Response){
    }
    //查看托运货物信息
    rpc GetConsignments (GetRequest) returns (Response){
    }
}

//定义客户端请求的数据格式
//货轮承运的一批货物
message Consignment{
    string id = 1;                          //货物编号
    string description = 2;                 //货物描述
    int32 weight = 3;                       //货物重量
    repeated Container containers = 4;      //这批货有哪些集装箱
    string vessel_id = 5;                   //承运的货轮
}

//定义客户端请求的数据格式
//单个集装箱
message Container{
    string id = 1;                          //集装箱编号
    string customer_id = 2;                 //集装箱所属客户的编号
    string origin = 3;                      //出发地
    string user_id = 4;                     //集装箱所属用户的编号
}

//定义服务端响应的数据格式
//托运结果
message Response{
    bool created = 1;                       //托运成功
    Consignment consignment = 2;            //新托运的货物
    repeated Consignment consignments = 3;  //目前所有托运的货物
}

//查看货物信息的请求
//客户端想要从服务端请求数据，必须有请求格式，哪怕为空
message GetRequest{

}
```

### 编译 user.proto文件
- 使用Makefile文件
```
build:
	protoc --go_out=plugins=grpc:. ./proto/consignment.proto
#	protoc --go_out=. ./proto/consignment.proto

```
- 执行
```
make build
```

### 生成consignment.pb.go
```
// Code generated by protoc-gen-go. DO NOT EDIT.
// source: proto/consignment.proto

package go_micro_srv_consignment

import (
	context "context"
	fmt "fmt"
	proto "github.com/golang/protobuf/proto"
	grpc "google.golang.org/grpc"
	math "math"
)

// Reference imports to suppress errors if they are not otherwise used.
var _ = proto.Marshal
var _ = fmt.Errorf
var _ = math.Inf

// This is a compile-time assertion to ensure that this generated file
// is compatible with the proto package it is being compiled against.
// A compilation error at this line likely means your copy of the
// proto package needs to be updated.
const _ = proto.ProtoPackageIsVersion2 // please upgrade the proto package

//定义客户端请求的数据格式.(string)
//货轮承运的一批货物
type Consignment struct {
	Id                   string       `protobuf:"bytes,1,opt,name=id,proto3" json:"id,omitempty"`
	Description          string       `protobuf:"bytes,2,opt,name=description,proto3" json:"description,omitempty"`
	Weight               int32        `protobuf:"varint,3,opt,name=weight,proto3" json:"weight,omitempty"`
	Containers           []*Container `protobuf:"bytes,4,rep,name=containers,proto3" json:"containers,omitempty"`
	VesselId             string       `protobuf:"bytes,5,opt,name=vessel_id,json=vesselId,proto3" json:"vessel_id,omitempty"`
	XXX_NoUnkeyedLiteral struct{}     `json:"-"`
	XXX_unrecognized     []byte       `json:"-"`
	XXX_sizecache        int32        `json:"-"`
}

func (m *Consignment) Reset()         { *m = Consignment{} }
func (m *Consignment) String() string { return proto.CompactTextString(m) }
func (*Consignment) ProtoMessage()    {}
func (*Consignment) Descriptor() ([]byte, []int) {
	return fileDescriptor_774f0b29a0c4f8e9, []int{0}
}

func (m *Consignment) XXX_Unmarshal(b []byte) error {
	return xxx_messageInfo_Consignment.Unmarshal(m, b)
}
func (m *Consignment) XXX_Marshal(b []byte, deterministic bool) ([]byte, error) {
	return xxx_messageInfo_Consignment.Marshal(b, m, deterministic)
}
func (m *Consignment) XXX_Merge(src proto.Message) {
	xxx_messageInfo_Consignment.Merge(m, src)
}
func (m *Consignment) XXX_Size() int {
	return xxx_messageInfo_Consignment.Size(m)
}
func (m *Consignment) XXX_DiscardUnknown() {
	xxx_messageInfo_Consignment.DiscardUnknown(m)
}

var xxx_messageInfo_Consignment proto.InternalMessageInfo

func (m *Consignment) GetId() string {
	if m != nil {
		return m.Id
	}
	return ""
}

func (m *Consignment) GetDescription() string {
	if m != nil {
		return m.Description
	}
	return ""
}

func (m *Consignment) GetWeight() int32 {
	if m != nil {
		return m.Weight
	}
	return 0
}

func (m *Consignment) GetContainers() []*Container {
	if m != nil {
		return m.Containers
	}
	return nil
}

func (m *Consignment) GetVesselId() string {
	if m != nil {
		return m.VesselId
	}
	return ""
}

//定义客户端请求的数据格式
//单个集装箱
type Container struct {
	Id                   string   `protobuf:"bytes,1,opt,name=id,proto3" json:"id,omitempty"`
	CustomerId           string   `protobuf:"bytes,2,opt,name=customer_id,json=customerId,proto3" json:"customer_id,omitempty"`
	Origin               string   `protobuf:"bytes,3,opt,name=origin,proto3" json:"origin,omitempty"`
	UserId               string   `protobuf:"bytes,4,opt,name=user_id,json=userId,proto3" json:"user_id,omitempty"`
	XXX_NoUnkeyedLiteral struct{} `json:"-"`
	XXX_unrecognized     []byte   `json:"-"`
	XXX_sizecache        int32    `json:"-"`
}

func (m *Container) Reset()         { *m = Container{} }
func (m *Container) String() string { return proto.CompactTextString(m) }
func (*Container) ProtoMessage()    {}
func (*Container) Descriptor() ([]byte, []int) {
	return fileDescriptor_774f0b29a0c4f8e9, []int{1}
}

func (m *Container) XXX_Unmarshal(b []byte) error {
	return xxx_messageInfo_Container.Unmarshal(m, b)
}
func (m *Container) XXX_Marshal(b []byte, deterministic bool) ([]byte, error) {
	return xxx_messageInfo_Container.Marshal(b, m, deterministic)
}
func (m *Container) XXX_Merge(src proto.Message) {
	xxx_messageInfo_Container.Merge(m, src)
}
func (m *Container) XXX_Size() int {
	return xxx_messageInfo_Container.Size(m)
}
func (m *Container) XXX_DiscardUnknown() {
	xxx_messageInfo_Container.DiscardUnknown(m)
}

var xxx_messageInfo_Container proto.InternalMessageInfo

func (m *Container) GetId() string {
	if m != nil {
		return m.Id
	}
	return ""
}

func (m *Container) GetCustomerId() string {
	if m != nil {
		return m.CustomerId
	}
	return ""
}

func (m *Container) GetOrigin() string {
	if m != nil {
		return m.Origin
	}
	return ""
}

func (m *Container) GetUserId() string {
	if m != nil {
		return m.UserId
	}
	return ""
}

//定义服务端响应的数据格式
//托运结果
type Response struct {
	Created              bool           `protobuf:"varint,1,opt,name=created,proto3" json:"created,omitempty"`
	Consignment          *Consignment   `protobuf:"bytes,2,opt,name=consignment,proto3" json:"consignment,omitempty"`
	Consignments         []*Consignment `protobuf:"bytes,3,rep,name=consignments,proto3" json:"consignments,omitempty"`
	XXX_NoUnkeyedLiteral struct{}       `json:"-"`
	XXX_unrecognized     []byte         `json:"-"`
	XXX_sizecache        int32          `json:"-"`
}

func (m *Response) Reset()         { *m = Response{} }
func (m *Response) String() string { return proto.CompactTextString(m) }
func (*Response) ProtoMessage()    {}
func (*Response) Descriptor() ([]byte, []int) {
	return fileDescriptor_774f0b29a0c4f8e9, []int{2}
}

func (m *Response) XXX_Unmarshal(b []byte) error {
	return xxx_messageInfo_Response.Unmarshal(m, b)
}
func (m *Response) XXX_Marshal(b []byte, deterministic bool) ([]byte, error) {
	return xxx_messageInfo_Response.Marshal(b, m, deterministic)
}
func (m *Response) XXX_Merge(src proto.Message) {
	xxx_messageInfo_Response.Merge(m, src)
}
func (m *Response) XXX_Size() int {
	return xxx_messageInfo_Response.Size(m)
}
func (m *Response) XXX_DiscardUnknown() {
	xxx_messageInfo_Response.DiscardUnknown(m)
}

var xxx_messageInfo_Response proto.InternalMessageInfo

func (m *Response) GetCreated() bool {
	if m != nil {
		return m.Created
	}
	return false
}

func (m *Response) GetConsignment() *Consignment {
	if m != nil {
		return m.Consignment
	}
	return nil
}

func (m *Response) GetConsignments() []*Consignment {
	if m != nil {
		return m.Consignments
	}
	return nil
}

//查看货物信息的请求
//客户端想要从服务端请求数据，必须有请求格式，哪怕为空
type GetRequest struct {
	XXX_NoUnkeyedLiteral struct{} `json:"-"`
	XXX_unrecognized     []byte   `json:"-"`
	XXX_sizecache        int32    `json:"-"`
}

func (m *GetRequest) Reset()         { *m = GetRequest{} }
func (m *GetRequest) String() string { return proto.CompactTextString(m) }
func (*GetRequest) ProtoMessage()    {}
func (*GetRequest) Descriptor() ([]byte, []int) {
	return fileDescriptor_774f0b29a0c4f8e9, []int{3}
}

func (m *GetRequest) XXX_Unmarshal(b []byte) error {
	return xxx_messageInfo_GetRequest.Unmarshal(m, b)
}
func (m *GetRequest) XXX_Marshal(b []byte, deterministic bool) ([]byte, error) {
	return xxx_messageInfo_GetRequest.Marshal(b, m, deterministic)
}
func (m *GetRequest) XXX_Merge(src proto.Message) {
	xxx_messageInfo_GetRequest.Merge(m, src)
}
func (m *GetRequest) XXX_Size() int {
	return xxx_messageInfo_GetRequest.Size(m)
}
func (m *GetRequest) XXX_DiscardUnknown() {
	xxx_messageInfo_GetRequest.DiscardUnknown(m)
}

var xxx_messageInfo_GetRequest proto.InternalMessageInfo

func init() {
	proto.RegisterType((*Consignment)(nil), "go.micro.srv.consignment.Consignment")
	proto.RegisterType((*Container)(nil), "go.micro.srv.consignment.Container")
	proto.RegisterType((*Response)(nil), "go.micro.srv.consignment.Response")
	proto.RegisterType((*GetRequest)(nil), "go.micro.srv.consignment.GetRequest")
}

func init() { proto.RegisterFile("proto/consignment.proto", fileDescriptor_774f0b29a0c4f8e9) }

var fileDescriptor_774f0b29a0c4f8e9 = []byte{
	// 349 bytes of a gzipped FileDescriptorProto
	0x1f, 0x8b, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0xff, 0x8c, 0x92, 0x4f, 0x4e, 0xf3, 0x30,
	0x10, 0xc5, 0xbf, 0xf4, 0x7f, 0x26, 0xd5, 0x57, 0xe1, 0x05, 0xb5, 0x60, 0x41, 0x14, 0x40, 0xea,
	0x2a, 0x48, 0xe5, 0x08, 0x59, 0x54, 0xd9, 0xba, 0x6b, 0x04, 0x25, 0x1e, 0xa5, 0x96, 0x88, 0x1d,
	0x6c, 0xb7, 0x5c, 0x0d, 0xae, 0xc1, 0x89, 0x50, 0x9d, 0x86, 0x1a, 0xa1, 0xa2, 0xee, 0xfc, 0x66,
	0xfc, 0xf3, 0x7b, 0x63, 0x0d, 0x4c, 0x6b, 0xad, 0xac, 0xba, 0x2b, 0x94, 0x34, 0xa2, 0x94, 0x15,
	0x4a, 0x9b, 0xba, 0x0a, 0xa1, 0xa5, 0x4a, 0x2b, 0x51, 0x68, 0x95, 0x1a, 0xbd, 0x4d, 0xbd, 0x7e,
	0xf2, 0x11, 0x40, 0x94, 0x1d, 0x34, 0xf9, 0x0f, 0x1d, 0xc1, 0x69, 0x10, 0x07, 0xb3, 0x90, 0x75,
	0x04, 0x27, 0x31, 0x44, 0x1c, 0x4d, 0xa1, 0x45, 0x6d, 0x85, 0x92, 0xb4, 0xe3, 0x1a, 0x7e, 0x89,
	0x9c, 0xc3, 0xe0, 0x0d, 0x45, 0xb9, 0xb6, 0xb4, 0x1b, 0x07, 0xb3, 0x3e, 0xdb, 0x2b, 0x92, 0x01,
	0x14, 0x4a, 0xda, 0x95, 0x90, 0xa8, 0x0d, 0xed, 0xc5, 0xdd, 0x59, 0x34, 0xbf, 0x4e, 0x8f, 0x05,
	0x49, 0xb3, 0xf6, 0x2e, 0xf3, 0x30, 0x72, 0x09, 0xe1, 0x16, 0x8d, 0xc1, 0x97, 0x47, 0xc1, 0x69,
	0xdf, 0x99, 0x8f, 0x9a, 0x42, 0xce, 0x93, 0x0a, 0xc2, 0x6f, 0xea, 0x57, 0xf0, 0x2b, 0x88, 0x8a,
	0x8d, 0xb1, 0xaa, 0x42, 0xbd, 0x63, 0x9b, 0xe0, 0xd0, 0x96, 0x72, 0xbe, 0xcb, 0xad, 0xb4, 0x28,
	0x85, 0x74, 0xb9, 0x43, 0xb6, 0x57, 0x64, 0x0a, 0xc3, 0x8d, 0x69, 0xa0, 0x5e, 0xd3, 0xd8, 0xc9,
	0x9c, 0x27, 0xef, 0x01, 0x8c, 0x18, 0x9a, 0x5a, 0x49, 0x83, 0x84, 0xc2, 0xb0, 0xd0, 0xb8, 0xb2,
	0xd8, 0x78, 0x8e, 0x58, 0x2b, 0xc9, 0x02, 0x22, 0x6f, 0x2e, 0x67, 0x1c, 0xcd, 0x6f, 0xff, 0x1c,
	0xbc, 0x3d, 0x33, 0x9f, 0x24, 0x39, 0x8c, 0x3d, 0x69, 0x68, 0xd7, 0x7d, 0xe1, 0x89, 0x2f, 0xfd,
	0x40, 0x93, 0x31, 0xc0, 0x02, 0x2d, 0xc3, 0xd7, 0x0d, 0x1a, 0x3b, 0xff, 0x0c, 0x60, 0xb2, 0x5c,
	0x8b, 0xba, 0x16, 0xb2, 0x5c, 0xa2, 0xde, 0x8a, 0x02, 0xc9, 0x13, 0x9c, 0x65, 0x6e, 0x00, 0x7f,
	0x19, 0x4e, 0xf3, 0xba, 0x48, 0x8e, 0x5f, 0x6b, 0xff, 0x2b, 0xf9, 0x47, 0x1e, 0x60, 0xb2, 0x40,
	0xeb, 0x71, 0x86, 0xdc, 0x1c, 0x07, 0x0f, 0x71, 0x4f, 0x7b, 0xfe, 0x79, 0xe0, 0x36, 0xfd, 0xfe,
	0x2b, 0x00, 0x00, 0xff, 0xff, 0x63, 0xa0, 0x39, 0xe2, 0x04, 0x03, 0x00, 0x00,
}

// Reference imports to suppress errors if they are not otherwise used.
var _ context.Context
var _ grpc.ClientConn

// This is a compile-time assertion to ensure that this generated file
// is compatible with the grpc package it is being compiled against.
const _ = grpc.SupportPackageIsVersion4

// ShippingServiceClient is the client API for ShippingService service.
//
// For semantics around ctx use and closing/ending streaming RPCs, please refer to https://godoc.org/google.golang.org/grpc#ClientConn.NewStream.
type ShippingServiceClient interface {
	//托运一批货物
	CreateConsignment(ctx context.Context, in *Consignment, opts ...grpc.CallOption) (*Response, error)
	//查看托运货物信息
	GetConsignments(ctx context.Context, in *GetRequest, opts ...grpc.CallOption) (*Response, error)
}

type shippingServiceClient struct {
	cc *grpc.ClientConn
}

func NewShippingServiceClient(cc *grpc.ClientConn) ShippingServiceClient {
	return &shippingServiceClient{cc}
}

func (c *shippingServiceClient) CreateConsignment(ctx context.Context, in *Consignment, opts ...grpc.CallOption) (*Response, error) {
	out := new(Response)
	err := c.cc.Invoke(ctx, "/go.micro.srv.consignment.ShippingService/CreateConsignment", in, out, opts...)
	if err != nil {
		return nil, err
	}
	return out, nil
}

func (c *shippingServiceClient) GetConsignments(ctx context.Context, in *GetRequest, opts ...grpc.CallOption) (*Response, error) {
	out := new(Response)
	err := c.cc.Invoke(ctx, "/go.micro.srv.consignment.ShippingService/GetConsignments", in, out, opts...)
	if err != nil {
		return nil, err
	}
	return out, nil
}

// ShippingServiceServer is the server API for ShippingService service.
type ShippingServiceServer interface {
	//托运一批货物
	CreateConsignment(context.Context, *Consignment) (*Response, error)
	//查看托运货物信息
	GetConsignments(context.Context, *GetRequest) (*Response, error)
}

func RegisterShippingServiceServer(s *grpc.Server, srv ShippingServiceServer) {
	s.RegisterService(&_ShippingService_serviceDesc, srv)
}

func _ShippingService_CreateConsignment_Handler(srv interface{}, ctx context.Context, dec func(interface{}) error, interceptor grpc.UnaryServerInterceptor) (interface{}, error) {
	in := new(Consignment)
	if err := dec(in); err != nil {
		return nil, err
	}
	if interceptor == nil {
		return srv.(ShippingServiceServer).CreateConsignment(ctx, in)
	}
	info := &grpc.UnaryServerInfo{
		Server:     srv,
		FullMethod: "/go.micro.srv.consignment.ShippingService/CreateConsignment",
	}
	handler := func(ctx context.Context, req interface{}) (interface{}, error) {
		return srv.(ShippingServiceServer).CreateConsignment(ctx, req.(*Consignment))
	}
	return interceptor(ctx, in, info, handler)
}

func _ShippingService_GetConsignments_Handler(srv interface{}, ctx context.Context, dec func(interface{}) error, interceptor grpc.UnaryServerInterceptor) (interface{}, error) {
	in := new(GetRequest)
	if err := dec(in); err != nil {
		return nil, err
	}
	if interceptor == nil {
		return srv.(ShippingServiceServer).GetConsignments(ctx, in)
	}
	info := &grpc.UnaryServerInfo{
		Server:     srv,
		FullMethod: "/go.micro.srv.consignment.ShippingService/GetConsignments",
	}
	handler := func(ctx context.Context, req interface{}) (interface{}, error) {
		return srv.(ShippingServiceServer).GetConsignments(ctx, req.(*GetRequest))
	}
	return interceptor(ctx, in, info, handler)
}

var _ShippingService_serviceDesc = grpc.ServiceDesc{
	ServiceName: "go.micro.srv.consignment.ShippingService",
	HandlerType: (*ShippingServiceServer)(nil),
	Methods: []grpc.MethodDesc{
		{
			MethodName: "CreateConsignment",
			Handler:    _ShippingService_CreateConsignment_Handler,
		},
		{
			MethodName: "GetConsignments",
			Handler:    _ShippingService_GetConsignments_Handler,
		},
	},
	Streams:  []grpc.StreamDesc{},
	Metadata: "proto/consignment.proto",
}

```

### 客户端client.go
```
package main

import (
	"context"
	"encoding/json"
	"errors"
	"fmt"
	pb "go-grpc/prepare/2-ShippingService/proto"
	"google.golang.org/grpc"
	"io/ioutil"
	"log"
	"os"
	"strings"
)

const (
	ADDRESS           = "127.0.0.1:50051"
	DEFAULT_INFO_FILE = "consignment.json"
)

//读取consignment.json中记录的货物信息
func parseFile(fileName string) (*pb.Consignment, error) {
	data, err := ioutil.ReadFile(fileName)
	if err != nil {
		return nil, err
	}

	var consignment *pb.Consignment
	err = json.Unmarshal(data, &consignment)
	if err != nil {
		return nil, errors.New("consignment.json file content error")
	}
	return consignment, nil
}

func main() {
	//连接到grpc服务器
	conn, err := grpc.Dial(ADDRESS, grpc.WithInsecure())
	if err != nil {
		log.Fatalf("connect error:%v", err)
	}
	defer conn.Close()

	//初始化gprc客户端
	client := pb.NewShippingServiceClient(conn)

	//在命令行中指定新的货物信息json文件
	infoFile := DEFAULT_INFO_FILE
	if len(os.Args) > 1 {
		infoFile = os.Args[1]
	}

	consignment, err := parseFile(infoFile)
	if err != nil {
		log.Fatalf("parse info file error:%v", err)
	}

	//调用rpc
	//将货物存储到我们自己的仓库
	resp, err := client.CreateConsignment(context.Background(), consignment)
	if err != nil {
		log.Fatalf("create consignment error:%v", err)
	}

	//新货物是否托运成功
	fmt.Printf("created: %t", resp.Created)
	fmt.Println(resp.Consignment)
	fmt.Println(strings.Repeat("==", 30))
	//列出目前所有的货物
	resp, err = client.GetConsignments(context.Background(), &pb.GetRequest{})
	for k, c := range resp.Consignments {
		fmt.Printf("第%d次:%+v\n", k, c)
	}

}

```
### 服务端server.go
```
package main

import (
	"context"
	"fmt"
	pb "go-grpc/prepare/2-ShippingService/proto"
	"google.golang.org/grpc"
	"log"
	"net"
)

//服务端

const (
	PORT = ":50051"
)

//仓库接口
type IRepository interface {
	Create(consignment *pb.Consignment) (*pb.Consignment, error) //存放新货物
	GetAll() []*pb.Consignment                                   //获取仓库中所有货物
}

//我们存放多批货物的仓库，实现了IRepository接口
type Repository struct {
	consignments []*pb.Consignment
}

func (repo *Repository) Create(consignment *pb.Consignment) (*pb.Consignment, error) {
	repo.consignments = append(repo.consignments, consignment)
	return consignment, nil
}

func (repo *Repository) GetAll() []*pb.Consignment {
	return repo.consignments
}

//定义微服务
type service struct {
	repo Repository
}

//service 实现consignment.pb.go中的ShippingServiceServer接口
//使service作为grpc的服务端

//托运新的货物
func (s *service) CreateConsignment(ctx context.Context, req *pb.Consignment) (*pb.Response, error) {
	//接收承运的获取
	consignment, err := s.repo.Create(req)
	if err != nil {
		return nil, err
	}
	resp := &pb.Response{
		Created:     true,
		Consignment: consignment,
	}
	log.Println(consignment)
	fmt.Println("托运成功")
	return resp, nil
}

//获取目前所有托运的货物
func (s *service) GetConsignments(ctx context.Context, req *pb.GetRequest) (*pb.Response, error) {
	allConsignments := s.repo.GetAll()
	resp := &pb.Response{
		Consignments: allConsignments,
	}
	return resp, nil
}
func main() {
	listener, err := net.Listen("tcp", PORT)
	if err != nil {
		log.Fatalf("failed to listen: %v", err)
	}
	log.Printf("listen on: %s\n", PORT)

	server := grpc.NewServer()
	repo := Repository{}

	//向rpc服务器注册微服务
	//此时会把我们实现的微服务service与协议中的ShippingServiceServer绑定
	pb.RegisterShippingServiceServer(server, &service{repo: repo})

	if err := server.Serve(listener); err != nil {
		log.Fatalf("failed to serve: %v", err)
	}
}

```